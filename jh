تمام! جهزت لك Console App (Batch .CMD) منظم بقائمة تفاعلية يعمل الآتي:

إعداد RRAS لعمل L2TP/IPsec VPN بمفتاح مشترك (PSK) + رينج عناوين عملاء.

تفعيل NPS وإنشاء Policy يسمح فقط لأعضاء جروب VPN_Users (محليًا أو في الدومين).

Logging: تفعيل لوج الفايروول + NPS.

إدارة المستخدمين (إضافة/حذف) وإضافتهم لجروب الـ VPN.

تعديل الإعدادات (PSK، رينج العناوين، تقييد RDP).

فتح أدوات GUI المفيدة (RRAS / NPS / Firewall / Local Users …).

Rollback لاسترجاع معظم التغييرات.


انسخ الكود التالي في ملف باسم مثلًا: VpnConsole.cmd وشغّله Run as Administrator.

@echo off
setlocal EnableExtensions EnableDelayedExpansion
title VPN Console (RRAS + NPS) - L2TP/IPsec

REM =====================[ CONFIG (Editable) ]=====================
set "PSK=ChangeMe-StrongPSK!"
set "VPN_POOL_START=10.10.50.100"
set "VPN_POOL_END=10.10.50.200"
set "VPN_SUBNET_CIDR=10.10.50.0/24"
set "VPN_GROUP=VPN_Users"
set "FIREWALL_LOG=C:\Windows\System32\LogFiles\Firewall\pfirewall.log"
set "FIREWALL_LOG_MAXKB=32768"
REM ===============================================================

REM Detect domain context
for /f "skip=1 tokens=1,*" %%a in ('wmic computersystem get domain ^| findstr /r /v "^$"') do set "MACHINE_DOMAIN=%%a"
if /I "%MACHINE_DOMAIN%"=="%COMPUTERNAME%" (
  set "IS_DOMAIN_JOINED=0"
  set "NPS_GROUP=%COMPUTERNAME%\%VPN_GROUP%"
) else (
  set "IS_DOMAIN_JOINED=1"
  set "NPS_GROUP=%MACHINE_DOMAIN%\%VPN_GROUP%"
)

:menu
cls
echo ============================================================
echo   RRAS L2TP/IPsec VPN Console  -  Run as Administrator
echo ============================================================
echo  Machine domain: %MACHINE_DOMAIN%   (Domain joined: %IS_DOMAIN_JOINED%)
echo  VPN Group     : %NPS_GROUP%
echo ------------------------------------------------------------
echo  1) Full Setup (RRAS + NPS + Logging + RDP hardening)
echo  2) Add VPN User (local) 
echo  3) Delete VPN User (local)
echo  4) Change PSK
echo  5) Change Client IP Pool
echo  6) Toggle RDP Restriction (allow ONLY from VPN subnet)
echo  7) Open GUI tools (RRAS / NPS / Firewall / Users / Logs)
echo  8) Rollback (remove policy/rules, stop RRAS)
echo  9) Show Current Status
echo  Q) Quit
echo ------------------------------------------------------------
set /p "choice=Select: "
if /I "%choice%"=="1" goto setup
if /I "%choice%"=="2" goto adduser
if /I "%choice%"=="3" goto deluser
if /I "%choice%"=="4" goto chgpsk
if /I "%choice%"=="5" goto chgpool
if /I "%choice%"=="6" goto rdprestrict
if /I "%choice%"=="7" goto opengui
if /I "%choice%"=="8" goto rollback
if /I "%choice%"=="9" goto status
if /I "%choice%"=="Q" goto :eof
goto menu

:setup
echo [*] Installing roles (RRAS + NPS) and configuring VPN...
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
  "Install-WindowsFeature RemoteAccess,Routing,DirectAccess-VPN,NPAS -IncludeManagementTools | Out-Null; " ^
  "Import-Module RemoteAccess; " ^
  "if (Get-Service RemoteAccess -ErrorAction SilentlyContinue) { try { Stop-Service RemoteAccess -Force } catch {} } ; " ^
  "Install-RemoteAccess -VpnType Vpn; " ^
  "Set-VpnServerConfiguration -TunnelType L2tpOnly -L2tpPsk (ConvertTo-SecureString -String '%PSK%' -AsPlainText -Force) | Out-Null; " ^
  "Set-VpnAuthProtocol -UserAuthProtocolAccepted MSCHAPv2 | Out-Null; " ^
  "Set-VpnServerConfiguration -EncryptionType Maximum | Out-Null; " ^
  "Start-Service RemoteAccess; Set-Service RemoteAccess -StartupType Automatic"

echo [*] Configure client IP pool...
netsh ras ip set addrassign static >nul
netsh ras ip delete range all >nul 2>&1
netsh ras ip add range %VPN_POOL_START% %VPN_POOL_END% >nul

echo [*] Open L2TP/IPsec ports (UDP 500, 4500, 1701)...
netsh advfirewall firewall add rule name="Allow UDP 500 (IKE)"    dir=in action=allow protocol=UDP localport=500  >nul
netsh advfirewall firewall add rule name="Allow UDP 4500 (NAT-T)" dir=in action=allow protocol=UDP localport=4500 >nul
netsh advfirewall firewall add rule name="Allow UDP 1701 (L2TP)"  dir=in action=allow protocol=UDP localport=1701 >nul

echo [*] Create local VPN group (if missing)...
net localgroup "%VPN_GROUP%" >nul 2>&1 || net localgroup "%VPN_GROUP%" /add >nul

echo [*] Enable Firewall logging (dropped + allowed)...
for %%P in (domainprofile privateprofile publicprofile) do (
  netsh advfirewall set %%P logging droppedconnections enable >nul
  netsh advfirewall set %%P logging allowedconnections enable >nul
  netsh advfirewall set %%P logging filename "%FIREWALL_LOG%" >nul
  netsh advfirewall set %%P logging maxfilesize %FIREWALL_LOG_MAXKB% >nul
)

echo [*] Configure NPS logging and policy...
REM Register NPS in AD if domain-joined (needs Domain Admin)
if "%IS_DOMAIN_JOINED%"=="1" (
  netsh nps add registeredserver >nul 2>&1
)
REM NPS logs (IAS format)
netsh nps set logging accounting enable=yes >nul 2>&1
netsh nps set logging authentication enable=yes >nul 2>&1
netsh nps set logging logfile format=ias path="C:\Windows\System32\LogFiles" rollover=Daily >nul 2>&1

REM Create/replace Network Policy that grants VPN for the group
netsh nps delete np name="VPN Access (Console)" >nul 2>&1
netsh nps add np name="VPN Access (Console)" processingorder=1 state=enabled grant=Grant >nul
netsh nps add condition policyname="VPN Access (Console)" conditionid="NAS-Port-Type" value="Virtual (VPN)" >nul
netsh nps add condition policyname="VPN Access (Console)" conditionid="Windows-Groups" value="%NPS_GROUP%" >nul 2>&1
netsh nps set np name="VPN Access (Console)" allowmicrosoftchapv2=enable >nul
netsh nps set np name="VPN Access (Console)" allowpap=disable allowchap=disable allowmschap=disable >nul
netsh nps set np name="VPN Access (Console)" encryptionlevel=strongest >nul

REM RDP hardening (enable allow-from-VPN only + block others)
call :apply_rdprestrict on

echo.
echo [OK] Setup done.
pause
goto menu

:adduser
set "USR="
set "PWD="
echo Enter new local username:
set /p "USR=> "
if "%USR%"=="" goto menu
echo Enter password (visible while typing):
set /p "PWD=> "
if "%PWD%"=="" goto menu

net user "%USR%" "%PWD%" /add /expires:never /y
if errorlevel 1 ( echo [!] Failed to create user & pause & goto menu )
net localgroup "%VPN_GROUP%" "%USR%" /add
if errorlevel 1 ( echo [!] Created user but failed to add to group "%VPN_GROUP%". & pause & goto menu )
echo [OK] User "%USR%" created and added to "%VPN_GROUP%".
pause
goto menu

:deluser
set "USR="
echo Enter local username to delete:
set /p "USR=> "
if "%USR%"=="" goto menu
net user "%USR%" >nul 2>&1 || ( echo [!] User not found & pause & goto menu )
net user "%USR%" /delete
if errorlevel 1 ( echo [!] Failed to delete user & pause & goto menu )
echo [OK] User "%USR%" deleted.
pause
goto menu

:chgpsk
set "NEWPSK="
echo Enter NEW L2TP PSK:
set /p "NEWPSK=> "
if "%NEWPSK%"=="" goto menu
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
  "Import-Module RemoteAccess; Set-VpnServerConfiguration -TunnelType L2tpOnly -L2tpPsk (ConvertTo-SecureString -String '%NEWPSK%' -AsPlainText -Force) | Out-Null"
if errorlevel 1 ( echo [!] Failed to set PSK & pause & goto menu )
set "PSK=%NEWPSK%"
echo [OK] PSK updated.
pause
goto menu

:chgpool
set "NEWSTART="
set "NEWEND="
set "NEWCIDR="
echo Enter NEW pool start IP (e.g., 10.10.50.100):
set /p "NEWSTART=> "
echo Enter NEW pool end IP (e.g., 10.10.50.200):
set /p "NEWEND=> "
echo Enter VPN subnet CIDR for firewall allow (e.g., 10.10.50.0/24):
set /p "NEWCIDR=> "
if "%NEWSTART%"=="" goto menu
if "%NEWEND%"=="" goto menu
if "%NEWCIDR%"=="" goto menu

netsh ras ip set addrassign static >nul
netsh ras ip delete range all >nul 2>&1
netsh ras ip add range %NEWSTART% %NEWEND% >nul
if errorlevel 1 ( echo [!] Failed to set pool & pause & goto menu )

set "VPN_POOL_START=%NEWSTART%"
set "VPN_POOL_END=%NEWEND%"
set "VPN_SUBNET_CIDR=%NEWCIDR%"

REM Update RDP rule to match new subnet
call :apply_rdprestrict refresh

echo [OK] VPN pool updated.
pause
goto menu

:rdprestrict
echo 1) Enable RDP restriction (only from VPN subnet)
echo 2) Disable RDP restriction (restore default Remote Desktop rules)
set /p "opt=> "
if "%opt%"=="1" ( call :apply_rdprestrict on & goto menu )
if "%opt%"=="2" ( call :apply_rdprestrict off & goto menu )
goto menu

:apply_rdprestrict
REM %1 = on/off/refresh
if /I "%1"=="off" (
  netsh advfirewall firewall delete rule name="Allow RDP from VPN (%VPN_SUBNET_CIDR%)" >nul 2>&1
  netsh advfirewall firewall delete rule name="Block RDP from non-VPN" >nul 2>&1
  netsh advfirewall set rule group="remote desktop" new enable=yes >nul
  echo [OK] RDP restriction disabled.
  goto :eof
)

if /I "%1"=="on" (
  netsh advfirewall set rule group="remote desktop" new enable=no >nul
)

REM refresh or on -> ensure custom rules exist (recreate)
netsh advfirewall firewall delete rule name="Allow RDP from VPN (%VPN_SUBNET_CIDR%)" >nul 2>&1
netsh advfirewall firewall delete rule name="Block RDP from non-VPN" >nul 2>&1

netsh advfirewall firewall add rule name="Allow RDP from VPN (%VPN_SUBNET_CIDR%)" ^
  dir=in action=allow protocol=TCP localport=3389 remoteip=%VPN_SUBNET_CIDR% program=System profile=any >nul

netsh advfirewall firewall add rule name="Block RDP from non-VPN" ^
  dir=in action=block protocol=TCP localport=3389 program=System profile=any >nul

echo [OK] RDP allowed only from %VPN_SUBNET_CIDR%.
goto :eof

:opengui
echo ------------------------------------------------------------
echo 1) RRAS console               (rrasmgmt.msc)
echo 2) NPS console                (nps.msc)
echo 3) Windows Firewall (Advanced) (wf.msc)
echo 4) Local Users and Groups     (lusrmgr.msc)
echo 5) Event Viewer (NPS/RRAS logs)
echo 6) Open Firewall log file
echo 7) Open logs folder
echo B) Back
echo ------------------------------------------------------------
set /p "g=Open: "
if /I "%g%"=="1" start mmc.exe rrasmgmt.msc
if /I "%g%"=="2" start mmc.exe nps.msc
if /I "%g%"=="3" start wf.msc
if /I "%g%"=="4" start lusrmgr.msc
if /I "%g%"=="5" start eventvwr.msc
if /I "%g%"=="6" start notepad.exe "%FIREWALL_LOG%"
if /I "%g%"=="7" explorer.exe "C:\Windows\System32\LogFiles"
goto menu

:rollback
echo [!] This will stop RRAS, remove custom firewall rules and NPS policy "VPN Access (Console)".
choice /M "Proceed"
if errorlevel 2 goto menu

netsh advfirewall firewall delete rule name="Allow UDP 500 (IKE)" >nul 2>&1
netsh advfirewall firewall delete rule name="Allow UDP 4500 (NAT-T)" >nul 2>&1
netsh advfirewall firewall delete rule name="Allow UDP 1701 (L2TP)" >nul 2>&1
netsh advfirewall firewall delete rule name="Allow RDP from VPN (%VPN_SUBNET_CIDR%)" >nul 2>&1
netsh advfirewall firewall delete rule name="Block RDP from non-VPN" >nul 2>&1
netsh advfirewall set rule group="remote desktop" new enable=yes >nul

netsh nps delete np name="VPN Access (Console)" >nul 2>&1

powershell -NoProfile -ExecutionPolicy Bypass -Command ^
  "if (Get-Service RemoteAccess -ErrorAction SilentlyContinue) { try { Stop-Service RemoteAccess -Force } catch {} }"

echo [OK] Rollback complete. (Roles/features remain installed.)
pause
goto menu

:status
cls
echo ===== Current Status =====
echo PSK           : (hidden)
echo Pool          : %VPN_POOL_START% - %VPN_POOL_END%
echo VPN Subnet    : %VPN_SUBNET_CIDR%
echo VPN Group     : %NPS_GROUP%
echo ---------------
echo RRAS service:
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
  "Get-Service RemoteAccess | Select-Object Status,StartType | Format-List"
echo ---------------
echo NPS policy:
netsh nps show np name="VPN Access (Console)" | findstr /r /c:"Name" /c:"State" /c:"Processing"
echo ---------------
echo Firewall rules (L2TP/IPsec + RDP restriction):
netsh advfirewall firewall show rule name="Allow UDP 500 (IKE)"    | findstr /c:"Enabled" /c:"LocalPort" /c:"Direction"
netsh advfirewall firewall show rule name="Allow UDP 4500 (NAT-T)" | findstr /c:"Enabled" /c:"LocalPort" /c:"Direction"
netsh advfirewall firewall show rule name="Allow UDP 1701 (L2TP)"  | findstr /c:"Enabled" /c:"LocalPort" /c:"Direction"
netsh advfirewall firewall show rule name="Allow RDP from VPN (%VPN_SUBNET_CIDR%)" | findstr /c:"Enabled" /c:"LocalPort" /c:"RemoteIP"
echo ==========================
pause
goto menu

إزاي تستخدم الـ Console App

1. افتح CMD كـ Administrator.


2. نفّذ VpnConsole.cmd.


3. اختَر 1) Full Setup لأول مرة. دا هي:

يثبّت الأدوار: RRAS + NPS.

يفعّل L2TP/IPsec بمفتاح PSK.

يضبط رينج عناوين العملاء.

يفتح بورتات UDP 500/4500/1701.

يفعّل Logging للفايروول + NPS.

ينشئ Policy في NPS تسمح فقط لأعضاء VPN_Users.

يقيّد RDP بحيث مسموح فقط من شبكة الـ VPN.



4. استخدم 2) Add VPN User لإضافة مستخدم محلي بسرعة (بينضم لجروب VPN_Users).


5. لو عايز تشيل مستخدم: 3) Delete VPN User.


6. لتغيير PSK أو IP Pool: اختَر الخيارات 4 أو 5.


7. 6) Toggle RDP Restriction لو عايز تفعل/تعطّل تقييد الـ RDP.


8. 7) Open GUI tools لفتح الأدوات الرسومية مباشرة (RRAS/NPS/Firewall/Users/Logs).


9. 8) Rollback يرجّع أغلب التغييرات: يوقف RRAS، يحذف قواعد الفايروول وسياسة NPS اللي عملناها، ويعيد قواعد RDP الافتراضية. (لن يزيل الأدوار المثبتة).


10. 9) Show Current Status يعرض حالة الخدمة والسياسات والقواعد.



ملاحظات مهمة

Port Forward على الراوتر/الفايروول الخارجي مطلوب:
UDP 500, 4500, 1701 → على IP السيرفر.

لو السيرفر عضو دومين وتملك صلاحيات Domain Admin، الاختيار 1 هيحاول Register NPS في AD تلقائيًا. لو معندكش الصلاحية، كمل التسجيل من nps.msc يدويًا.

سياسة NPS اللي بيعملها السكربت اسمها: VPN Access (Console) وبترخّص لأعضاء %NPS_GROUP%.

إدارة “Dial-in” لكل مستخدم مش مطلوبة لو بتستخدم NPS + Group (وهو الأفضل).

تنبيه كلمة السر في إضافة المستخدم: الإدخال غير مخفي في CMD. ممكن تستخدم GUI lusrmgr.msc من قائمة GUI لو تفضّل.

لو حبيت تضيف IKEv2 كمان، أقدر أديك تحديث بسيط يضيف أمر PowerShell لتمكينه جنب L2TP.


لو عايز أحوله لنسخة PowerShell كاملة بواجهة قائمة مشابهة (أنظف وأسهل في التعامل مع الـ cmdlets)، أو تضيف خيارات متقدمة (Geo-IP blocking، Certificates بدلاً من PSK…)، قولي واظبطهالك.

